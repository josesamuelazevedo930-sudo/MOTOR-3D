// 1. LIMPEZA E ESTILOS
if(document.getElementById('ui-career')) document.getElementById('ui-career').remove();
if(document.getElementById('chapa-screen')) document.getElementById('chapa-screen').remove();

const style = document.createElement('style');
style.innerHTML = `
    .btn-job { width: 100%; padding: 10px; margin-top: 5px; background: #222; color: #0ff; border: 1px solid #0ff; cursor: pointer; font-family: monospace; }
    .burger { width: 60px; height: 60px; border-radius: 50%; background: #633; margin: 10px; display: inline-block; border: 4px solid #422; transition: 0.3s; }
    .fritando { background: #842 !important; border-color: #f80 !important; box-shadow: 0 0 10px #f80; }
    .pronto { background: #420 !important; border-color: #0f0 !important; box-shadow: 0 0 15px #0f0; }
`;
document.head.appendChild(style);

// 2. PAINEL INICIAL (SÓ APARECE PARA CONFIGURAR)
const ui = document.createElement('div');
ui.id = 'ui-career';
ui.style.cssText = "position:absolute; right:20px; top:100px; width:180px; background:rgba(0,0,0,0.9); padding:15px; border:2px solid #0ff; z-index:10000; color:#0ff; font-family:monospace; text-align:center;";
ui.innerHTML = `
    <b>MODO CARREIRA</b><br><br>
    <div id="status-txt">Configure os locais</div>
    <button class="btn-job" onclick="setLoc('chapa')">SET CHAPA</button>
    <button class="btn-job" onclick="setLoc('balcao')">SET BALCAO</button>
    <button class="btn-job" id="btn-play" style="display:none; background:#0ff; color:#000;" onclick="startDuty()">INICIAR TURNO</button>
    <br><div id="cash-txt">$$: 0</div>
`;
document.body.appendChild(ui);

// 3. TELA DA CHAPA (MINI-GAME) - INVISÍVEL NO INÍCIO
const gameScreen = document.createElement('div');
gameScreen.id = 'chapa-screen';
gameScreen.style.cssText = "position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:300px; background:rgba(30,30,30,0.95); border:5px solid #555; border-radius:15px; padding:20px; text-align:center; display:none; z-index:10001; color:white; font-family:monospace;";
gameScreen.innerHTML = `
    <h3 style="color:#f80; margin:0;">GRELHA DO SIRI</h3>
    <p style="font-size:10px;">CLIQUE NO BURGER QUANDO FICAR VERDE!</p>
    <div id="slot-1" class="burger"></div>
    <div id="slot-2" class="burger"></div><br>
    <button id="btn-fechar-chapa" style="margin-top:10px; font-size:10px;">SAIR DA CHAPA</button>
`;
document.body.appendChild(gameScreen);

// 4. LÓGICA DO JOGO
let locs = { chapa: null, balcao: null };
let grana = 0;
let emServico = false;
let burgersProntos = 0;

window.setLoc = (tipo) => {
    const p = window.player || player;
    locs[tipo] = p.position.clone();
    document.getElementById('status-txt').innerText = tipo.toUpperCase() + " OK!";
    if(locs.chapa && locs.balcao) document.getElementById('btn-play').style.display = 'block';
};

window.startDuty = () => {
    emServico = true;
    ui.style.display = 'none'; // Esconde o menu para não atrapalhar
    avisarCentral("TURNO INICIADO! VA ATE A CHAPA");
};

function avisarCentral(t) {
    const m = document.createElement('div');
    m.style.cssText = "position:absolute; top:20%; left:50%; transform:translate(-50%,-50%); color:#0ff; font-size:20px; font-weight:bold; text-shadow:2px 2px #000; z-index:10002; pointer-events:none; font-family:sans-serif;";
    m.innerText = t;
    document.body.appendChild(m);
    setTimeout(() => m.remove(), 3000);
}

// SIMULADOR DE FRITURA
function abrirChapa() {
    gameScreen.style.display = 'block';
    const slots = [document.getElementById('slot-1'), document.getElementById('slot-2')];
    
    slots.forEach(s => {
        s.className = 'burger';
        s.onclick = null;
        
        // Começa a fritar
        setTimeout(() => {
            s.classList.add('fritando');
            setTimeout(() => {
                s.classList.add('pronto');
                s.onclick = () => {
                    burgersProntos++;
                    s.className = 'burger'; // Reseta slot
                    s.onclick = null;
                    avisarCentral("HAMBURGUER PRONTO! ("+burgersProntos+"/2)");
                    if(burgersProntos >= 2) {
                        setTimeout(() => {
                            gameScreen.style.display = 'none';
                            avisarCentral("LEVE PARA O BALCAO!");
                        }, 500);
                    }
                };
            }, 3000 + Math.random() * 2000);
        }, 1000);
    });
}

document.getElementById('btn-fechar-chapa').onclick = () => gameScreen.style.display = 'none';

// LOOP DE CHECAGEM
setInterval(() => {
    if(!emServico) return;
    const p = window.player || player;
    
    let distChapa = p.position.distanceTo(locs.chapa);
    let distBalcao = p.position.distanceTo(locs.balcao);

    // Se chegar na chapa e não tiver burger pronto
    if(distChapa < 4 && gameScreen.style.display === 'none' && burgersProntos === 0) {
        abrirChapa();
    }

    // Se chegar no balcão com os lanches
    if(distBalcao < 4 && burgersProntos >= 2) {
        grana += 100;
        burgersProntos = 0;
        document.getElementById('cash-txt').innerText = "$$: " + grana;
        avisarCentral("PEDIDO ENTREGUE! +$100");
        setTimeout(() => avisarCentral("VOLTE PARA A CHAPA!"), 2000);
    }
}, 500);
