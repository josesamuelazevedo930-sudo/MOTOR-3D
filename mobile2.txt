(function() {
    // 1. Estilos Necess√°rios para HUD e Movimenta√ß√£o
    const style = document.createElement('style');
    style.innerHTML = `
        .draggable-panel { touch-action: none; cursor: move; }
        .edit-mode-active { border: 2px dashed #ff00ff !important; opacity: 0.8; }
        #hud-save-btn { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 15px; background: #ff00ff; color: #fff; font-weight: bold;
            border-radius: 10px; z-index: 10000; display: none;
        }
        .panel { resize: both; overflow: auto !important; } /* Pain√©is redimension√°veis */
    `;
    document.head.appendChild(style);

    const hudSave = document.createElement('button');
    hudSave.id = "hud-save-btn"; hudSave.innerText = "‚úÖ SALVAR POSI√á√ïES";
    document.body.appendChild(hudSave);

    // 2. L√≥gica para tornar qualquer elemento ARRAST√ÅVEL (Touch)
    function makeDraggable(el, storageKey) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        
        // Carregar posi√ß√£o salva
        const saved = JSON.parse(localStorage.getItem(storageKey));
        if (saved) {
            el.style.top = saved.top; el.style.left = saved.left;
            el.style.bottom = 'auto'; el.style.right = 'auto';
        }

        el.addEventListener('touchstart', dragStart);

        function dragStart(e) {
            if (!window.isEditMode && !el.classList.contains('panel')) return;
            pos3 = e.touches[0].clientX;
            pos4 = e.touches[0].clientY;
            document.addEventListener('touchend', dragEnd);
            document.addEventListener('touchmove', dragMove);
        }

        function dragMove(e) {
            pos1 = pos3 - e.touches[0].clientX;
            pos2 = pos4 - e.touches[0].clientY;
            pos3 = e.touches[0].clientX;
            pos4 = e.touches[0].clientY;
            el.style.top = (el.offsetTop - pos2) + "px";
            el.style.left = (el.offsetLeft - pos1) + "px";
            el.style.bottom = 'auto'; el.style.right = 'auto';
        }

        function dragEnd() {
            document.removeEventListener('touchend', dragEnd);
            document.removeEventListener('touchmove', dragMove);
            if(window.isEditMode) {
                localStorage.setItem(storageKey, JSON.stringify({
                    top: el.style.top, left: el.style.left
                }));
            }
        }
    }

    // 3. Ativar nos elementos do seu jogo
    makeDraggable(document.getElementById('joy-outer'), 'pos_joy');
    makeDraggable(document.getElementById('jump-btn'), 'pos_jump');
    document.querySelectorAll('.panel').forEach((p, i) => makeDraggable(p, 'pos_panel_' + i));

    // 4. Bot√£o de Alternar Modo Editor
    const editBtn = document.createElement('button');
    editBtn.innerText = "üîß EDITAR HUD";
    editBtn.className = "ui-btn";
    editBtn.style.cssText = "position:absolute; top:10px; left:10px; background:#444; color:#fff; z-index:10001;";
    document.body.appendChild(editBtn);

    editBtn.onclick = () => {
        window.isEditMode = !window.isEditMode;
        hudSave.style.display = window.isEditMode ? 'block' : 'none';
        document.getElementById('joy-outer').classList.toggle('edit-mode-active');
        document.getElementById('jump-btn').classList.toggle('edit-mode-active');
        alert(window.isEditMode ? "Modo Editor: Arraste os bot√µes!" : "Modo Jogo: HUD travado.");
    };

    hudSave.onclick = () => editBtn.click();

    // 5. Ajuste do Joystick (Eixo Fixo)
    let moveX = 0, moveZ = 0, isMoving = false;
    // ... (Aqui entra a l√≥gica do Joystick V2 enviada anteriormente, mas com moveZ e moveX corrigidos)
    // Para evitar invers√£o:
    // player.position.addScaledVector(f, -moveZ * moveSpeed); // -moveZ para frente ser para frente
    // player.position.addScaledVector(r, -moveX * moveSpeed); // -moveX para direita ser direita
})();
