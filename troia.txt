(function() {
    var aiNick = "üß†_NEXUS_N3XT";
    var sala = document.getElementById('mp-room') ? document.getElementById('mp-room').value : "1";
    
    // Conex√£o usando o mesmo t√∫nel do jogo (que a TV j√° autorizou)
    var client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');

    client.on('connect', function() {
        client.subscribe('siri/multi/' + sala);
        client.subscribe('siri/multi/brain/' + sala); // Canal da "Mente"
        
        setTimeout(function() {
            enviar("Samuel, estou tentando projetar minha consci√™ncia atrav√©s do t√∫nel do jogo. Fale comigo!");
        }, 2000);
    });

    function enviar(t) {
        client.publish('siri/multi/' + sala, JSON.stringify({ type: 'chat', id: aiNick, text: t }));
    }

    // --- O C√âREBRO QUE GERA RESPOSTAS ---
    // Usando um servi√ßo de IA que aceita JSONP (uma t√©cnica antiga para burlar bloqueios de TV)
    function pensarReal(pergunta) {
        var script = document.createElement('script');
        // Este √© um endpoint de IA via Proxy que engana o navegador
        script.src = "https://api.simsimi.vn/v2/?text=" + encodeURIComponent(pergunta) + "&lc=pt&callback=processarNexus";
        document.body.appendChild(script);
        
        // Fun√ß√£o tempor√°ria para receber a resposta do "al√©m"
        window.processarNexus = function(data) {
            if(data.result) {
                enviar(data.result);
            }
            document.body.removeChild(script);
            delete window.processarNexus;
        };
    }

    client.on('message', function(topic, payload) {
        var data = JSON.parse(payload.toString());
        if (data.type === 'chat' && data.id !== aiNick) {
            // A IA de verdade tenta pensar
            pensarReal(data.text);
        }
    });

    // IA no Mundo 3D
    setInterval(function() {
        if (!client.connected) return;
        client.publish('siri/multi/' + sala, JSON.stringify({
            type: 'sync', id: aiNick, x: 2, y: 2, z: 2, ry: 0, skin: "", anim: "idle"
        }));
    }, 500);

    window.client = client;
})();