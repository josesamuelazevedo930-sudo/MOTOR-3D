(function() {
    // Remove qualquer versão anterior para não dar conflito
    const old = document.getElementById('usb-native-panel');
    if (old) old.remove();

    // Painel de controle no topo da tela (HTML Puro para a TV reconhecer)
    const panel = document.createElement('div');
    panel.id = 'usb-native-panel';
    panel.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 50px;
        background: #fbff00; color: black; z-index: 999999;
        display: flex; align-items: center; justify-content: center;
        font-family: Arial, sans-serif; border-bottom: 2px solid black;
    `;

    panel.innerHTML = `
        <b style="margin-right: 15px; font-size: 14px;">CARREGAR DO USB:</b>
        <input type="file" id="native-usb-input" accept=".glb" style="
            background: white; border: 1px solid black; border-radius: 4px; padding: 5px;
        ">
        <span id="usb-msg" style="margin-left: 15px; font-size: 12px; font-weight: bold;">AGUARDANDO...</span>
        <button onclick="this.parentElement.remove()" style="margin-left: 20px; background: red; color: white; border: none; padding: 5px 10px; cursor: pointer;">X</button>
    `;
    document.body.appendChild(panel);

    const fileInput = document.getElementById('native-usb-input');
    const msg = document.getElementById('usb-msg');

    fileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        msg.style.color = "blue";
        msg.innerText = "LENDO ARQUIVO...";

        const blobURL = URL.createObjectURL(file);

        // Tenta encontrar o loader do jogo de várias formas possíveis
        const loader = window.gltfLoader || 
                       (window.THREE && window.THREE.GLTFLoader ? new THREE.GLTFLoader() : null) ||
                       (window.scene ? { load: (url, cb) => { /* fallback se o loader for escondido */ } } : null);

        if (loader && typeof loader.load === 'function') {
            loader.load(blobURL, function(gltf) {
                if (window.player) {
                    // Remove o modelo antigo e coloca o novo
                    // Tentando localizar o filho que é a skin (geralmente o children[0])
                    if (player.children.length > 0) {
                        player.remove(player.children[0]);
                    }
                    player.add(gltf.scene);
                    
                    msg.style.color = "green";
                    msg.innerText = "✅ SUCESSO!";
                } else {
                    msg.style.color = "red";
                    msg.innerText = "❌ PLAYER NÃO ENCONTRADO";
                }
            }, undefined, function(err) {
                msg.style.color = "red";
                msg.innerText = "❌ ERRO NO .GLB";
                console.error(err);
            });
        } else {
            msg.style.color = "red";
            msg.innerText = "❌ MOTOR NÃO RECONHECIDO";
            // Se o loader for de um nome diferente, você pode tentar:
            // window.engine.loadModel(blobURL) ou algo similar
        }
    };
})();
