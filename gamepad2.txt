(function() {
    console.log("üéÆ Iniciando Driver Universal de Gamepad...");
    
    // Vari√°veis de estado para evitar disparos repetidos
    let lastJumpTime = 0;

    function universalLoop() {
        const gamepads = navigator.getGamepads();
        
        for (let gp of gamepads) {
            if (!gp) continue;

            // --- 1. MOVIMENTA√á√ÉO (MAPEAMENTO AGRESSIVO) ---
            // Checa os eixos 0 e 1 (Anal√≥gico Esquerdo padr√£o)
            const d = 0.25; // Deadzone contra drift
            
            // Esquerda/Direita
            keys['KeyD'] = gp.axes[0] > d || (gp.axes[4] && gp.axes[4] > d);
            keys['KeyA'] = gp.axes[0] < -d || (gp.axes[4] && gp.axes[4] < -d);
            
            // Frente/Tr√°s
            keys['KeyS'] = gp.axes[1] > d || (gp.axes[5] && gp.axes[5] > d);
            keys['KeyW'] = gp.axes[1] < -d || (gp.axes[5] && gp.axes[5] < -d);

            // --- 2. ROTA√á√ÉO DA C√ÇMERA (QUALQUER ANAL√ìGICO DIREITO) ---
            // Tenta eixos 2, 3 ou 5 (comuns em controles chineses/gen√©ricos)
            let look = 0;
            if (Math.abs(gp.axes[2]) > d) look = gp.axes[2];
            else if (Math.abs(gp.axes[3]) > d) look = gp.axes[3];
            else if (gp.axes[5] && Math.abs(gp.axes[5]) > d) look = gp.axes[5];
            
            if (look !== 0) {
                camRot -= look * 0.06;
            }

            // --- 3. PULO (QUALQUER BOT√ÉO √â PULO) ---
            // Percorre todos os bot√µes do controle. Se apertar qualquer um, ele pula.
            for (let i = 0; i < gp.buttons.length; i++) {
                if (gp.buttons[i].pressed) {
                    let now = Date.now();
                    if (now - lastJumpTime > 300) { // Delay para n√£o pular infinitamente
                        jump();
                        lastJumpTime = now;
                    }
                    break; 
                }
            }
        }
        requestAnimationFrame(universalLoop);
    }

    // Feedback visual para voc√™ saber que o jogo est√° ouvindo
    window.addEventListener("gamepadconnected", (e) => {
        console.log("Conectado: " + e.gamepad.id);
        const msg = document.createElement('div');
        msg.style = "position:fixed; top:50px; left:50%; transform:translateX(-50%); background:rgba(0,255,0,0.8); color:black; padding:10px; border-radius:10px; z-index:9999;";
        msg.innerText = "CONTROLE DETECTADO! MOVA OS ANAL√ìGICOS";
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
    });

    universalLoop();
})();
