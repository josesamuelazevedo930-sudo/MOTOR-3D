// 1. LIMPEZA E BIBLIOTECA
if(document.getElementById('ui-multi')) document.getElementById('ui-multi').remove();
if (!window.Peer) {
    let s = document.createElement('script');
    s.src = "https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js";
    document.head.appendChild(s);
}

// 2. INTERFACE COM ID PERSONALIZADO
const uiMulti = document.createElement('div');
uiMulti.id = 'ui-multi';
uiMulti.style.cssText = "position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.95); padding:15px; color:white; border-radius:10px; z-index:10000; font-family:sans-serif; border:2px solid #00ffff; width:220px;";
uiMulti.innerHTML = `
    <div id="setup-mp">
        <b style="color:#00ffff">SIRI ONLINE V3</b><br>
        <small id="status-net" style="color:yellow">Iniciando Rede...</small><br><br>
        <input type="text" id="my-custom-id" placeholder="Crie ID da Sala (ex: sala7)" style="width:90%; padding:5px; margin-bottom:5px; background:#222; color:#fff; border:1px solid #444;">
        <button id="btn-start-peer" style="width:100%; background:#007bff; color:white; border:none; padding:5px; margin-bottom:10px;">CRIAR SALA</button>
        <hr style="border:0; border-top:1px solid #333;">
        <input type="text" id="target-id" placeholder="ID do Amigo para entrar" style="width:90%; padding:5px; margin-top:5px; background:#222; color:#fff; border:1px solid #444;">
        <button id="btn-con" style="width:100%; margin-top:8px; background:#28a745; color:white; border:none; padding:8px; border-radius:4px; font-weight:bold;">ENTRAR NA SALA</button>
    </div>
    <div id="chat-box" style="display:none; margin-top:10px;">
        <div id="chat-logs" style="height:100px; overflow-y:auto; font-size:11px; background:#111; padding:5px; border:1px solid #333; margin-bottom:5px;"></div>
        <div style="display:flex; gap:2px;">
            <input type="text" id="chat-input" placeholder="Mensagem..." style="flex:1; background:#222; color:#fff; border:1px solid #444; padding:5px;">
            <button id="btn-send" style="background:#007bff; color:white; border:none; padding:5px;">Ok</button>
        </div>
    </div>
`;
document.body.appendChild(uiMulti);

let peer, conn, remotePlayer, remoteLabel, myLabel, remoteSkinUrl;
let myNick = "Player";

// 3. FUNÇÃO PARA CRIAR A SALA
document.getElementById('btn-start-peer').onclick = () => {
    let customId = document.getElementById('my-custom-id').value.trim();
    if(!customId) return alert("Digite um nome para a sala!");
    
    if(peer) peer.destroy();
    peer = new Peer(customId); // Tenta criar a sala com seu nome

    peer.on('open', (id) => {
        document.getElementById('status-net').innerText = "SALA ATIVA: " + id;
        document.getElementById('status-net').style.color = "#00ff00";
    });

    peer.on('error', (err) => {
        if(err.type === 'unavailable-id') alert("Esse nome de sala já existe! Tente outro.");
        else alert("Erro: " + err.type);
    });

    peer.on('connection', (c) => {
        conn = c;
        initNetwork();
    });
};

// 4. FUNÇÃO PARA ENTRAR NA SALA DO AMIGO
document.getElementById('btn-con').onclick = () => {
    let targetId = document.getElementById('target-id').value.trim();
    if(!targetId) return alert("Digite o ID do amigo!");

    if(!peer) peer = new Peer(); // Se não criou sala, cria um peer aleatório só pra conectar

    conn = peer.connect(targetId);
    document.getElementById('status-net').innerText = "Conectando...";
    initNetwork();
};

function initNetwork() {
    conn.on('open', () => {
        document.getElementById('setup-mp').style.display = 'none';
        document.getElementById('chat-box').style.display = 'block';
        alert("CONECTADO COM SUCESSO!");
        
        // Loop de Sincronização
        setInterval(() => {
            if(conn && conn.open) {
                conn.send({
                    type: 'sync', nick: myNick,
                    x: player.position.x, y: player.position.y, z: player.position.z,
                    ry: player.rotation.y, skin: window.currentSkinUrl
                });
            }
        }, 50);
    });

    conn.on('data', data => {
        if(data.type === 'sync') handleSync(data);
        if(data.type === 'chat') handleChat(data);
    });

    conn.on('close', () => alert("Conexão perdida!"));
}

// LOGICA DE SYNC E CHAT (Igual anterior, mas mais robusta)
function handleSync(data) {
    if(!remotePlayer || data.skin !== remoteSkinUrl) {
        if(remotePlayer) scene.remove(remotePlayer);
        remoteSkinUrl = data.skin;
        loaderGLTF.load(data.skin || "https://threejs.org/examples/models/gltf/Soldier.glb", (gltf) => {
            remotePlayer = gltf.scene; scene.add(remotePlayer);
            createRemoteLabel(data.nick);
        });
    }
    if(remotePlayer) {
        remotePlayer.position.set(data.x, data.y, data.z);
        remotePlayer.rotation.y = data.ry;
        if(remoteLabel) {
            remoteLabel.position.set(data.x, data.y + 10, data.z);
            remoteLabel.lookAt(camera.position);
        }
    }
}

function handleChat(data) {
    const log = document.getElementById('chat-logs');
    log.innerHTML += `<div><b style="color:#00ffff">${data.nick}:</b> ${data.msg}</div>`;
    log.scrollTop = log.scrollHeight;
}

function createRemoteLabel(text) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 256; canvas.height = 128;
    ctx.font = 'Bold 40px Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center';
    ctx.fillText(text || "Amigo", 128, 64);
    const tex = new THREE.CanvasTexture(canvas);
    remoteLabel = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
    remoteLabel.scale.set(8, 4, 1);
    scene.add(remoteLabel);
}

document.getElementById('btn-send').onclick = () => {
    let input = document.getElementById('chat-input');
    if(input.value && conn && conn.open) {
        conn.send({ type: 'chat', msg: input.value, nick: myNick });
        handleChat({nick: "Eu", msg: input.value});
        input.value = "";
    }
};
