(function() {
    // 1. Criar a Interface do Menu Circular
    const menuHTML = `
        <div id="emote-circle" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:300px; height:300px; border-radius:50%; background:rgba(0,0,0,0.6); border:4px solid #00ffff; z-index:9999; align-items:center; justify-content:center;">
            <div class="emote-btn" onclick="tocarEmote(0)" style="position:absolute; top:10px; left:120px; cursor:pointer;">üï∫ Dan√ßar</div>
            <div class="emote-btn" onclick="tocarEmote(1)" style="position:absolute; bottom:10px; left:120px; cursor:pointer;">üëã Tchau</div>
            <div class="emote-btn" onclick="tocarEmote(2)" style="position:absolute; left:10px; top:120px; cursor:pointer;">ü¶æ Pose</div>
            <div class="emote-btn" onclick="tocarEmote(3)" style="position:absolute; right:10px; top:120px; cursor:pointer;">ü§£ Rir</div>
            <div style="color:#00ffff; font-weight:bold;">NEXUS EMOTES</div>
        </div>
        <style>
            .emote-btn { background:#00ffff; color:#000; padding:10px; border-radius:5px; font-weight:bold; transition:0.2s; }
            .emote-btn:hover { transform:scale(1.2); background:#fff; }
        </style>
    `;
    document.body.insertAdjacentHTML('beforeend', menuHTML);

    const menu = document.getElementById('emote-circle');

    // 2. Abrir/Fechar com a tecla "E" (igual em muitos jogos)
    window.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'e') {
            menu.style.display = (menu.style.display === 'none') ? 'flex' : 'none';
        }
    });

    // 3. L√≥gica de Inje√ß√£o de Anima√ß√£o
    window.tocarEmote = function(index) {
        if (!window.player || !window.player.animations) {
            console.log("NEXUS: Modelo sem anima√ß√µes detectadas.");
            return;
        }

        // Criar o Mixer se n√£o existir
        if (!window.mixer) {
            window.mixer = new THREE.AnimationMixer(window.player);
        }

        // Para a anima√ß√£o atual e toca a nova
        window.mixer.stopAllAction();
        const animation = window.player.animations[index];
        
        if (animation) {
            const action = window.mixer.clipAction(animation);
            action.setLoop(THREE.LoopOnce); // Toca uma vez
            action.clampWhenFinished = true; // Para no √∫ltimo frame (n√£o volta pra T-Pose)
            action.play();
            console.log("NEXUS: Executando emote " + index);
        }
        
        menu.style.display = 'none'; // Fecha o menu
    };

    // 4. Loop de atualiza√ß√£o (Necess√°rio para a anima√ß√£o rodar)
    const clock = new THREE.Clock();
    function update() {
        requestAnimationFrame(update);
        if (window.mixer) {
            window.mixer.update(clock.getDelta());
        }
    }
    update();

})();
