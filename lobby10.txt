(function() {
    const lobbyImg = "https://github.com/josesamuelazevedo930-sudo/Imageees/raw/main/1771787535592.png";
    const lobbyMusic = "https://github.com/josesamuelazevedo930-sudo/MP3/raw/main/%5BNon Copyrighted Music%5D _MiguelJohnson - Good Day To Die %5BEpic%5D(MP3_160K).mp3";
    
    let inLobby = true;
    let client, meuNome, sala = "Siri_Sala_Privada_2026";
    let remotePlayers = {};
    const jScene = window.scene || scene;

    const oldUI = ['s-btn', 'h-btn', 'i-btn', 'loader', 'jump-btn'];
    oldUI.forEach(id => { if(document.getElementById(id)) document.getElementById(id).style.display = 'none'; });

    const audio = new Audio(lobbyMusic); audio.loop = true;
    new THREE.TextureLoader().load(lobbyImg, (tex) => { jScene.background = tex; });

    // --- INTERFACE ---
    const loginDiv = document.createElement('div');
    loginDiv.style.cssText = "position:fixed; left:20px; top:20px; width:220px; background:rgba(255,255,255,0.9); padding:15px; border-radius:5px; z-index:10000; font-family:sans-serif; border:1px solid #ccc;";
    loginDiv.innerHTML = `<p style="margin:0 0 10px 0; font-size:12px; font-weight:bold; color:#333;">ENTRAR NO JOGO:</p><input id="nick-in" placeholder="Seu Nick" style="width:90%; padding:8px; margin-bottom:10px; border:1px solid #999;"><button id="enter-btn" style="width:100%; padding:10px; background:#444; color:#fff; border:none; cursor:pointer; font-weight:bold;">CONECTAR</button>`;
    document.body.appendChild(loginDiv);

    const startBtn = document.createElement('button');
    startBtn.innerText = "START";
    startBtn.style.cssText = "position:fixed; bottom:30px; right:30px; width:140px; height:70px; background:#ffcc00; color:#000; font-size:20px; font-weight:bold; border:4px solid #fff; border-radius:10px; cursor:pointer; z-index:9000; display:none;";
    document.body.appendChild(startBtn);

    const chatBtn = document.createElement('button');
    chatBtn.innerText = "CHAT";
    chatBtn.style.cssText = "position:fixed; left:20px; top:20px; padding:10px; z-index:9500; display:none; background:#444; color:#fff; border:none; font-weight:bold;";
    document.body.appendChild(chatBtn);

    const chatUI = document.createElement('div');
    chatUI.style.cssText = "position:fixed; left:20px; top:65px; width:280px; background:rgba(0,0,0,0.8); padding:10px; display:none; z-index:9500; border-radius:5px;";
    chatUI.innerHTML = `<div id="logs" style="height:120px; overflow-y:auto; color:#fff; font-size:12px; margin-bottom:8px; font-family:monospace;"></div><div style="display:flex; gap:5px;"><input id="c-in" style="flex:1; padding:5px;"><button id="c-send" style="padding:5px 15px; background:#ffcc00; border:none; font-weight:bold;">OK</button></div>`;
    document.body.appendChild(chatUI);

    // --- FUNÇÃO BALÃO DE CHAT ---
    function mostrarMensagemNoPlayer(obj, texto) {
        if(!obj) return;
        if(obj.userData.msgSprite) obj.remove(obj.userData.msgSprite);

        const canvas = document.createElement('canvas');
        canvas.width = 512; canvas.height = 128;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.roundRect(0, 0, 512, 128, 20); ctx.fill();
        ctx.fillStyle = '#ffffff'; ctx.font = 'bold 40px Arial';
        ctx.textAlign = 'center'; ctx.fillText(texto, 256, 80);

        const tex = new THREE.CanvasTexture(canvas);
        const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
        sprite.scale.set(8, 2, 1);
        sprite.position.set(0, 12, 0); // Fica em cima da cabeça
        obj.add(sprite);
        obj.userData.msgSprite = sprite;
        setTimeout(() => { if(obj.userData.msgSprite === sprite) { obj.remove(sprite); obj.userData.msgSprite = null; } }, 5000);
    }

    // --- MQTT E REDE ---
    if(!window.mqtt) { const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/mqtt@4.1.0/dist/mqtt.min.js'; document.head.appendChild(s); }

    function connect() {
        meuNome = document.getElementById('nick-in').value || "User_" + Math.floor(Math.random()*99);
        loginDiv.style.display = 'none'; startBtn.style.display = 'block';
        client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
        client.on('connect', () => { client.subscribe('siri/multi/' + sala); audio.play().catch(()=>{}); });
        client.on('message', (topic, msg) => {
            const data = JSON.parse(msg.toString());
            if(data.id === meuNome) return;
            if(data.type === 'sync') {
                if(!remotePlayers[data.id]) {
                    remotePlayers[data.id] = criarAvatar(data.id);
                    // No lobby, coloca o novo player ao lado (offset)
                    if(inLobby) {
                        let count = Object.keys(remotePlayers).length;
                        remotePlayers[data.id].position.x = (count % 2 === 0) ? count * 5 : count * -5;
                        remotePlayers[data.id].position.y = -6;
                    }
                }
                const p = remotePlayers[data.id];
                if(!inLobby) { p.position.set(data.x, data.y, data.z); }
                p.rotation.y = data.ry;
                p.lastSeen = Date.now();
            }
            if(data.type === 'chat') {
                document.getElementById('logs').innerHTML += `<div><b>${data.id}:</b> ${data.text}</div>`;
                mostrarMensagemNoPlayer(remotePlayers[data.id], data.text);
            }
        });
    }

    function criarAvatar(id) {
        const g = new THREE.Group();
        loaderGLTF.load('https://threejs.org/examples/models/gltf/Soldier.glb', (gltf) => {
            const m = gltf.scene; m.scale.set(8,8,8); g.add(m);
        });
        jScene.add(g); return g;
    }

    // --- LOOP ---
    if(player) { player.position.set(0, -6, 0); player.scale.set(10, 10, 10); } // Reduzi de 13 para 10
    if(mapModel) mapModel.visible = false;

    const originalAnimate = window.animate;
    function lobbyLoop() {
        if(!inLobby) return;
        requestAnimationFrame(lobbyLoop);
        if(mixer) mixer.update(clock.getDelta());
        if(keys['ArrowLeft']) player.rotation.y += 0.05;
        if(keys['ArrowRight']) player.rotation.y -= 0.05;
        camera.position.set(0, 0, 20); camera.lookAt(0, 0, 0);
        renderer.render(jScene, camera);
    }

    setInterval(() => {
        if(client && client.connected && player) {
            client.publish('siri/multi/'+sala, JSON.stringify({
                type: 'sync', id: meuNome, x: player.position.x, y: player.position.y, z: player.position.z, ry: player.rotation.y
            }));
        }
        for(let id in remotePlayers) if(Date.now() - remotePlayers[id].lastSeen > 5000) { jScene.remove(remotePlayers[id]); delete remotePlayers[id]; }
    }, 100);

    // --- EVENTOS ---
    document.getElementById('enter-btn').onclick = connect;
    chatBtn.onclick = () => { chatUI.style.display = chatUI.style.display === 'none' ? 'block' : 'none'; };
    startBtn.onclick = () => {
        inLobby = false; audio.pause(); startBtn.remove(); chatBtn.style.display = 'block';
        jScene.background = new THREE.Color(0x87CEEB); if(mapModel) mapModel.visible = true;
        if(player) player.scale.set(8, 8, 8);
        oldUI.forEach(id => { if(document.getElementById(id)) document.getElementById(id).style.display = 'block'; });
        window.animate = originalAnimate; respawn();
    };

    document.getElementById('c-send').onclick = () => {
        const i = document.getElementById('c-in');
        if(i.value && client) {
            client.publish('siri/multi/'+sala, JSON.stringify({type:'chat', id:meuNome, text:i.value}));
            document.getElementById('logs').innerHTML += `<div><b>Eu:</b> ${i.value}</div>`;
            mostrarMensagemNoPlayer(player, i.value);
            i.value = "";
        }
    };
    lobbyLoop();
})();
