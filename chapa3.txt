// 1. LIMPEZA TOTAL
if(document.getElementById('ui-career')) document.getElementById('ui-career').remove();
if(document.getElementById('chapa-screen')) document.getElementById('chapa-screen').remove();
if(document.getElementById('job-notif')) document.getElementById('job-notif').remove();

// 2. INTERFACE DE CONTROLE
const ui = document.createElement('div');
ui.id = 'ui-career';
ui.style.cssText = "position:absolute; right:10px; top:50px; width:180px; background:rgba(0,0,0,0.9); padding:10px; border:2px solid #0ff; z-index:10000; color:#0ff; font-family:sans-serif; text-align:center; border-radius:5px;";
ui.innerHTML = `
    <b style="font-size:14px;">SIRI JOB V3</b><br>
    <div id="job-info" style="font-size:11px; color:white; margin:5px 0;">Configure os locais:</div>
    <button id="btn-chapa" style="width:100%; margin-bottom:5px;">SET CHAPA</button>
    <button id="btn-balcao" style="width:100%; margin-bottom:5px;">SET BALCAO</button>
    <button id="btn-play" style="width:100%; display:none; background:#0ff; color:#000; font-weight:bold; border:none; padding:8px;">INICIAR TRABALHO</button>
    <div id="money-txt" style="margin-top:5px; font-weight:bold; color:#0f0;">$ 0</div>
`;
document.body.appendChild(ui);

// 3. TELA DA CHAPA (MINI-GAME)
const chapa = document.createElement('div');
chapa.id = 'chapa-screen';
chapa.style.cssText = "position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:280px; background:#333; border:4px solid #555; padding:20px; text-align:center; display:none; z-index:10001; color:white; border-radius:15px;";
chapa.innerHTML = `
    <h3 style="color:#f39c12; margin:0;">GRELHA ATIVA</h3>
    <p style="font-size:11px;">CLIQUE NO CIRCULO QUANDO FICAR VERDE</p>
    <div id="b1" style="width:60px; height:60px; background:#555; border-radius:50%; display:inline-block; margin:10px; border:4px solid #222; cursor:pointer;"></div>
    <div id="b2" style="width:60px; height:60px; background:#555; border-radius:50%; display:inline-block; margin:10px; border:4px solid #222; cursor:pointer;"></div>
    <br><button id="btn-exit" style="margin-top:10px;">SAIR</button>
`;
document.body.appendChild(chapa);

// 4. NOTIFICAÇÕES CENTRAIS
const notif = document.createElement('div');
notif.id = 'job-notif';
notif.style.cssText = "position:absolute; top:20%; left:50%; transform:translate(-50%,-50%); color:#0ff; font-weight:bold; font-size:18px; text-align:center; z-index:10002; pointer-events:none; text-shadow:2px 2px #000;";
document.body.appendChild(notif);

function avisar(t) { 
    notif.innerText = t; 
    setTimeout(() => { if(notif.innerText === t) notif.innerText = ""; }, 3000); 
}

// 5. LÓGICA DE FUNCIONAMENTO
let locChapa = null, locBalcao = null, grana = 0, lanchesProntos = 0, turnoAtivo = false;

document.getElementById('btn-chapa').onclick = () => {
    let p = window.player || player;
    locChapa = { x: p.position.x, y: p.position.y, z: p.position.z };
    avisar("CHAPA DEFINIDA!");
    verificarBotao();
};

document.getElementById('btn-balcao').onclick = () => {
    let p = window.player || player;
    locBalcao = { x: p.position.x, y: p.position.y, z: p.position.z };
    avisar("BALCAO DEFINIDO!");
    verificarBotao();
};

function verificarBotao() {
    if(locChapa && locBalcao) document.getElementById('btn-play').style.display = 'block';
}

document.getElementById('btn-play').onclick = () => {
    turnoAtivo = true;
    ui.style.display = 'none';
    avisar("TURNO INICIADO! VÁ ATÉ A CHAPA");
};

function abrirMinigame() {
    if(chapa.style.display === 'block') return;
    chapa.style.display = 'block';
    const slots = [document.getElementById('b1'), document.getElementById('b2')];
    
    slots.forEach(s => {
        s.style.background = "#555";
        s.onclick = null;
        setTimeout(() => {
            s.style.background = "#d35400"; // Fritando
            setTimeout(() => {
                s.style.background = "#27ae60"; // Pronto
                s.onclick = () => {
                    lanchesProntos++;
                    s.style.background = "#555";
                    s.onclick = null;
                    if(lanchesProntos >= 2) {
                        setTimeout(() => {
                            chapa.style.display = 'none';
                            avisar("PRONTO! LEVE AO BALCAO");
                        }, 500);
                    }
                };
            }, 3000);
        }, 1000);
    });
}

document.getElementById('btn-exit').onclick = () => chapa.style.display = 'none';

// LOOP DE DISTANCIA (Otimizado)
setInterval(() => {
    if(!turnoAtivo) return;
    let p = window.player || player;
    if(!p) return;

    // Cálculo manual de distância para evitar erros de biblioteca
    let dxC = p.position.x - locChapa.x;
    let dzC = p.position.z - locChapa.z;
    let distChapa = Math.sqrt(dxC*dxC + dzC*dzC);

    let dxB = p.position.x - locBalcao.x;
    let dzB = p.position.z - locBalcao.z;
    let distBalcao = Math.sqrt(dxB*dxB + dzB*dzB);

    if(distChapa < 4 && lanchesProntos === 0) {
        abrirMinigame();
    }

    if(distBalcao < 4 && lanchesProntos >= 2) {
        grana += 50;
        lanchesProntos = 0;
        document.getElementById('money-txt').innerText = "$ " + grana;
        avisar("ENTREGUE! +$50. VOLTE PARA A CHAPA!");
    }
}, 800);

avisar("CONFIGURE A CHAPA E O BALCAO");
