(function() {
    // 1. Limpeza de vest√≠gios anteriores
    var ids = ['ia-btn-toggle', 'ia-main-panel'];
    for (var i = 0; i < ids.length; i++) {
        var el = document.getElementById(ids[i]);
        if (el) el.parentNode.removeChild(el);
    }

    // 2. Carregamento da biblioteca Puter.js
    var puterScript = document.createElement('script');
    puterScript.src = 'https://js.puter.com/v2/';
    puterScript.onload = function() {
        console.log('C√©rebro da IA conectado via Puter.');
        initNexusSystem();
    };
    puterScript.onerror = function() {
        alert('Erro ao carregar Puter.js. Verifique internet ou navegador da TV.');
    };
    document.head.appendChild(puterScript);

    function initNexusSystem() {
        // --- Bot√£o de Abrir/Fechar ---
        var btn = document.createElement('button');
        btn.id = 'ia-btn-toggle';
        btn.innerHTML = 'ü§ñ IA';
        btn.style.cssText = "position:fixed; top:20px; left:20px; z-index:999999; background:#00ff00; color:black; border:2px solid #fff; padding:12px 20px; border-radius:10px; font-weight:bold; cursor:pointer; box-shadow: 0 0 15px rgba(0,255,0,0.5); font-size:18px;";
        document.body.appendChild(btn);

        // --- Painel Principal ---
        var panel = document.createElement('div');
        panel.id = 'ia-main-panel';
        panel.style.cssText = "position:fixed; top:85px; left:20px; width:320px; height:450px; background:rgba(0,0,0,0.95); border:3px solid #00ff00; border-radius:15px; display:none; flex-direction:column; z-index:999999; overflow:hidden; box-shadow: 0 0 30px #000; font-family: Arial, sans-serif;";
        
        panel.innerHTML = 
            '<div style="background:#00ff00; color:black; padding:10px; font-weight:bold; text-align:center; font-size:14px;">GEMINI NEXUS - REAL AI</div>' +
            '<div id="ia-log" style="flex:1; overflow-y:auto; padding:15px; color:#fff; font-size:12px; line-height:1.5; background:rgba(0,0,0,0.5);"></div>' +
            '<div style="padding:10px; background:#111; display:flex; gap:5px;">' +
                '<input id="ia-query" type="text" placeholder="Pe√ßa um script ou converse..." style="flex:1; background:#222; border:1px solid #00ff00; color:white; padding:10px; border-radius:5px; outline:none;">' +
                '<button id="ia-send-btn" style="background:#00ff00; border:none; padding:10px; border-radius:5px; font-weight:bold; cursor:pointer;">‚û§</button>' +
            '</div>' +
            '<div id="ia-status" style="font-size:9px; color:#666; text-align:center; padding-bottom:5px;">Status: Online (Puter Engine)</div>';
        
        document.body.appendChild(panel);

        var log = document.getElementById('ia-log');
        var input = document.getElementById('ia-query');
        var sendBtn = document.getElementById('ia-send-btn');

        // Fun√ß√£o para mostrar mensagens
        function addMessage(sender, text, color) {
            var m = document.createElement('div');
            m.style.marginBottom = "10px";
            m.innerHTML = "<b style='color:" + color + "'>" + sender + ":</b> " + text;
            log.appendChild(m);
            log.scrollTop = log.scrollHeight;
        }

        // Toggle do Painel
        btn.onclick = function() {
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                btn.style.background = '#ff0055';
                btn.innerHTML = '‚ùå';
            } else {
                panel.style.display = 'none';
                btn.style.background = '#00ff00';
                btn.innerHTML = 'ü§ñ IA';
            }
        };

        // L√≥gica de Envio com Timeout e Melhor Erro Handling
        function processAI() {
            var val = input.value.trim();
            if (!val) return;

            addMessage("Voc√™", val, "#fff");
            input.value = "";
            var processingMsg = addMessage("IA", "Processando...", "#aaa");

            const timeoutId = setTimeout(() => {
                log.removeChild(processingMsg);
                addMessage("ERRO", "Tempo esgotado. Tente novamente ou verifique conex√£o.", "red");
            }, 30000); // Timeout de 30s

            puter.ai.chat(val, { model: 'claude-3.5-sonnet' }) // Especifica model para mais estabilidade
                .then(function(response) {
                    clearTimeout(timeoutId);
                    log.removeChild(processingMsg);
                    
                    var textoIA = response.toString();
                    addMessage("IA", textoIA, "#00ff00");

                    // --- AUTO-EXECU√á√ÉO DE C√ìDIGO ---
                    if (textoIA.indexOf('```') !== -1) {
                        try {
                            var parts = textoIA.split('```');
                            var code = parts[1].replace('javascript', '').replace('js', '').trim();
                            
                            // Executa o c√≥digo no jogo
                            eval(code);
                            
                            var sysMsg = document.createElement('div');
                            sysMsg.style.cssText = "color:#00ffff; font-style:italic; font-size:10px; margin-top:5px; border-top:1px solid #333;";
                            sysMsg.innerHTML = "[SISTEMA]: Script injetado com sucesso!";
                            log.appendChild(sysMsg);
                        } catch (err) {
                            console.log("Erro ao rodar script da IA: " + err);
                            addMessage("ERRO", "Falha ao executar script: " + err.message, "red");
                        }
                    }
                }).catch(function(e) {
                    clearTimeout(timeoutId);
                    log.removeChild(processingMsg);
                    addMessage("ERRO", "Falha na conex√£o: " + e.message, "red");
                });
        }

        sendBtn.onclick = processAI;
        input.onkeypress = function(e) { if (e.key === 'Enter') processAI(); };

        addMessage("NEXUS", "Ol√° Samuel! Estou pronta. O que vamos criar?", "#00ff00");
    }
})();