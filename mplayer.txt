// ============================================
// SIRI MULTIPLAYER V6 - CHAT ROBLOX STYLE
// ============================================

if(document.getElementById('ui-multi')) document.getElementById('ui-multi').remove();

const mqttScript = document.createElement('script');
mqttScript.src = 'https://cdn.jsdelivr.net/npm/mqtt@4.1.0/dist/mqtt.min.js';
document.head.appendChild(mqttScript);

mqttScript.onload = () => { setupMultiplayerV6(); };

function setupMultiplayerV6() {
    // BOTﾃグ NO MENU
    const btnMenu = document.createElement('button');
    btnMenu.innerHTML = "M-PLAYER";
    btnMenu.style.cssText = "position:absolute; right:20px; top:240px; width:110px; padding:12px; color:white; border:none; font-weight:bold; border-radius:8px; z-index:1001; background:#ff00ff; box-shadow:0 4px #000; cursor:pointer;";
    btnMenu.onclick = () => {
        const p = document.getElementById('ui-multi');
        p.style.display = p.style.display === 'none' ? 'block' : 'none';
    };
    document.body.appendChild(btnMenu);

    // PAINEL DE CONTROLE
    const ui = document.createElement('div');
    ui.id = 'ui-multi';
    ui.style.cssText = "position:absolute; right:20px; top:295px; width:250px; background:rgba(0,0,0,0.95); border-radius:12px; padding:15px; color:white; border:1px solid #ff00ff; z-index:1000; display:none; font-family:sans-serif;";
    ui.innerHTML = `
        <div style="color:#ff00ff; font-weight:bold; text-align:center; margin-bottom:10px;">倹 MULTIPLAYER V6</div>
        <div id="setup-mp">
            <input id="mp-name" placeholder="Nome" style="width:90%; padding:8px; margin-bottom:5px; background:#222; color:#fff; border:1px solid #444;">
            <input id="mp-room" placeholder="Sala" value="1" style="width:90%; padding:8px; margin-bottom:10px; background:#222; color:#fff; border:1px solid #444;">
            <button id="btn-con" style="width:100%; padding:10px; background:#ff00ff; color:black; font-weight:bold; border-radius:6px; cursor:pointer;">CONECTAR</button>
        </div>
        <div id="mp-active" style="display:none;">
            <div id="chat-logs" style="height:80px; overflow-y:auto; font-size:11px; background:#111; color:#0ff; padding:8px; border:1px solid #333; margin-bottom:5px;"></div>
            <div style="display:flex; gap:5px;">
                <input id="chat-in" placeholder="Mensagem..." style="flex:1; background:#222; color:#fff; border:1px solid #444; padding:8px;">
                <button id="btn-send" style="padding:8px; background:#0ff; color:#000; font-weight:bold; border:none; border-radius:4px;">OK</button>
            </div>
            <div id="st-count" style="font-size:10px; color:#aaa; margin-top:10px; text-align:center;">則 JOGADORES: 0</div>
        </div>
    `;
    document.body.appendChild(ui);

    let client, sala, meuNome, remotePlayers = {};
    const jScene = window.scene || scene;
    const loader = (typeof GLTFLoader !== 'undefined') ? new GLTFLoader() : (window.loaderGLTF || new THREE.GLTFLoader());

    // FUNﾃﾃグ DO BALﾃグ DE CHAT (MELHORADA)
    function criarBalaoChat(playerGrupo, texto) {
        // Remove balﾃ｣o antigo se houver
        if (playerGrupo.userData.balao) {
            playerGrupo.remove(playerGrupo.userData.balao);
        }

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 512;
        canvas.height = 160;

        // Desenho do "Balﾃ｣o" (Fundo Branco Arredondado)
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.roundRect(10, 10, 492, 100, 30);
        ctx.fill();

        // Triﾃ｢ngulo do balﾃ｣o (pontinha)
        ctx.beginPath();
        ctx.moveTo(236, 110);
        ctx.lineTo(276, 110);
        ctx.lineTo(256, 140);
        ctx.fill();

        // Texto da Mensagem
        ctx.fillStyle = 'black';
        ctx.font = 'bold 38px Arial';
        ctx.textAlign = 'center';
        
        // Cortar texto se for muito longo
        let msg = texto.length > 25 ? texto.substring(0, 22) + "..." : texto;
        ctx.fillText(msg, 256, 75);

        const tex = new THREE.CanvasTexture(canvas);
        const spriteMat = new THREE.SpriteMaterial({ map: tex, depthTest: false });
        const sprite = new THREE.Sprite(spriteMat);
        
        // POSICIONAMENTO: Acima do Nick (Nick estﾃ｡ em y:10, balﾃ｣o vai para y:15)
        sprite.scale.set(8, 2.5, 1);
        sprite.position.set(0, 15, 0); 
        
        playerGrupo.add(sprite);
        playerGrupo.userData.balao = sprite;

        // Auto-destruiﾃｧﾃ｣o apﾃｳs 5 segundos
        setTimeout(() => {
            if (playerGrupo.userData.balao === sprite) {
                playerGrupo.remove(sprite);
                playerGrupo.userData.balao = null;
            }
        }, 5000);
    }

    function criarAvatarRemoto(id) {
        const grupo = new THREE.Group();
        
        // 1. CARREGAR MODELO GLB
        loader.load('https://threejs.org/examples/models/gltf/Soldier.glb', (gltf) => {
            const model = gltf.scene;
            model.scale.set(5, 5, 5);
            grupo.add(model);
        });

        // 2. NICKNAME (SPRITE)
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 256; canvas.height = 64;
        ctx.fillStyle = '#ff00ff';
        ctx.font = 'bold 32px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(id, 128, 45);
        
        const tex = new THREE.CanvasTexture(canvas);
        const label = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex }));
        label.scale.set(5, 1.2, 1);
        label.position.y = 10; // Altura do Nick
        grupo.add(label);

        jScene.add(grupo);
        return grupo;
    }

    // CONEXﾃグ
    document.getElementById('btn-con').onclick = () => {
        meuNome = document.getElementById('mp-name').value || "Player" + Math.floor(Math.random()*99);
        sala = document.getElementById('mp-room').value || "1";
        document.getElementById('setup-mp').style.display = 'none';
        document.getElementById('mp-active').style.display = 'block';

        client = mqtt.connect('wss://broker.emqx.io:8084/mqtt', { clientId: 'siri_' + Math.random().toString(36).substr(2, 5) });

        client.on('connect', () => {
            client.subscribe('siri/multi/' + sala);
            addLog("INFO", "Vocﾃｪ entrou na sala " + sala);
        });

        client.on('message', (topic, msg) => {
            try {
                const data = JSON.parse(msg.toString());
                if (data.id === meuNome) return;

                if (data.type === 'sync') {
                    if (!remotePlayers[data.id]) {
                        remotePlayers[data.id] = criarAvatarRemoto(data.id);
                        updateCounter();
                    }
                    remotePlayers[data.id].position.set(data.x, data.y, data.z);
                    remotePlayers[data.id].rotation.y = data.ry || 0;
                    remotePlayers[data.id].userData.lastSeen = Date.now();
                }
                
                if (data.type === 'chat') {
                    addLog(data.id, data.text);
                    if (remotePlayers[data.id]) {
                        criarBalaoChat(remotePlayers[data.id], data.text);
                    }
                }
            } catch(e){}
        });
    };

    // LOOP DE SINCRONIZAﾃﾃグ
    setInterval(() => {
        const pLocal = window.player || player;
        if (client && client.connected && pLocal) {
            client.publish('siri/multi/' + sala, JSON.stringify({
                type: 'sync', id: meuNome,
                x: pLocal.position.x, y: pLocal.position.y, z: pLocal.position.z,
                ry: pLocal.rotation.y
            }));
        }
        // Limpar inativos
        for(let id in remotePlayers) {
            if(Date.now() - remotePlayers[id].userData.lastSeen > 5000) {
                jScene.remove(remotePlayers[id]);
                delete remotePlayers[id];
                updateCounter();
            }
        }
    }, 100);

    // AUXILIARES
    function addLog(n, t) {
        const logs = document.getElementById('chat-logs');
        logs.innerHTML += `<div><b style="color:#ff00ff">${n}:</b> ${t}</div>`;
        logs.scrollTop = logs.scrollHeight;
    }

    function updateCounter() {
        document.getElementById('st-count').innerText = "則 JOGADORES: " + Object.keys(remotePlayers).length;
    }

    document.getElementById('btn-send').onclick = enviarMensagem;
    document.getElementById('chat-in').onkeydown = (e) => { if(e.key === 'Enter') enviarMensagem(); };

    function enviarMensagem() {
        const i = document.getElementById('chat-in');
        if(i.value && client) {
            client.publish('siri/multi/' + sala, JSON.stringify({ type: 'chat', id: meuNome, text: i.value }));
            addLog("Eu", i.value);
            i.value = "";
        }
    }
}
