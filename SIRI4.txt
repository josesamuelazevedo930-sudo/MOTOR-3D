// ============================================
// MODO COZINHEIRO - VERS√ÉO PAINEL
// COLE ISSO NO ARQUIVO .txt E IMPORTE!
// ============================================

// 1. LIMPEZA
if(window.chefAtivo) {
    if(window.chefTimer) clearInterval(window.chefTimer);
    if(window.chefMarcadorChapa) window.scene?.remove(window.chefMarcadorChapa);
    if(window.chefMarcadorBalcao) window.scene?.remove(window.chefMarcadorBalcao);
    if(document.getElementById('chef-panel')) document.getElementById('chef-panel').remove();
}

// 2. CAPTURAR CENA E PLAYER DO JOGO PRINCIPAL
let cenaJogo = null;
let jogador = null;

// TENTA CAPTURAR DE TODAS AS FORMAS POSS√çVEIS
if(typeof scene !== 'undefined') cenaJogo = scene;
if(typeof player !== 'undefined') jogador = player;
if(window.scene) cenaJogo = window.scene;
if(window.player) jogador = window.player;

// 3. SE N√ÉO ACHOU, TENTA NO PR√ìXIMO FRAME
if(!cenaJogo || !jogador) {
    alert("‚ö†Ô∏è AGUARDE... INJETANDO NO JOGO!");
    
    // INJETA DIRETO NO C√ìDIGO DO JOGO
    const script = document.createElement('script');
    script.innerHTML = `
        // CAPTURA AS VARI√ÅVEIS DO ESCOPO LOCAL
        window.minhaCena = scene;
        window.meuPlayer = player;
        
        // INICIA O MODO COZINHEIRO
        if(window.minhaCena && window.meuPlayer) {
            window.iniciarCozinhaFinal(window.minhaCena, window.meuPlayer);
        }
    `;
    document.head.appendChild(script);
    
    // AGUARDA E TENTA NOVAMENTE
    setTimeout(() => {
        if(window.minhaCena && window.meuPlayer) {
            window.iniciarCozinhaFinal(window.minhaCena, window.meuPlayer);
        }
    }, 1000);
} else {
    window.iniciarCozinhaFinal(cenaJogo, jogador);
}

// 4. FUN√á√ÉO PRINCIPAL (GARANTIDA)
window.iniciarCozinhaFinal = function(scene, player) {
    if(!scene || !player) {
        alert("‚ùå ERRO: N√£o conseguiu conectar ao jogo!");
        return;
    }
    
    console.log("‚úÖ CONECTADO AO JOGO!");
    window.chefAtivo = true;
    
    // 5. ESTADO
    window.chefState = {
        chapaPos: null,
        balcaoPos: null,
        chapaObj: null,
        balcaoObj: null,
        moedas: 0,
        fase: "AGUARDANDO"
    };
    
    // 6. INTERFACE M√çNIMA (SEM DEPEND√äNCIAS)
    if(!document.getElementById('chef-panel')) {
        const panel = document.createElement('div');
        panel.id = 'chef-panel';
        panel.style.cssText = `
            position: fixed;
            left: 20px;
            top: 200px;
            width: 250px;
            background: black;
            border: 3px solid magenta;
            border-radius: 10px;
            padding: 15px;
            color: white;
            z-index: 999999;
            font-family: Arial;
        `;
        panel.innerHTML = `
            <h3 style="color:magenta; text-align:center;">üë®‚Äçüç≥ COZINHEIRO</h3>
            <button id="btn-chapa" style="width:100%; padding:10px; background:magenta; color:white; border:none; margin:5px 0; font-weight:bold;">üî• MARCAR CHAPA</button>
            <button id="btn-balcao" style="width:100%; padding:10px; background:cyan; color:black; border:none; margin:5px 0; font-weight:bold;">üí∞ MARCAR BALC√ÉO</button>
            <div id="chef-status" style="background:#111; padding:10px; margin-top:10px; color:#0ff; text-align:center;">AGUARDANDO...</div>
            <div id="chef-money" style="font-size:24px; color:#0f0; text-align:center; margin-top:10px;">$0</div>
        `;
        document.body.appendChild(panel);
    }
    
    // 7. FUN√á√ÉO PARA CRIAR MARCADOR (SIMPLES E VIS√çVEL)
    function criarMarcador(cor, texto, pos) {
        const grupo = new THREE.Group();
        
        // CILINDRO ALTO E GROSSO
        const cilindro = new THREE.Mesh(
            new THREE.CylinderGeometry(2, 2, 20, 8),
            new THREE.MeshBasicMaterial({ 
                color: cor, 
                wireframe: true,
                transparent: true,
                opacity: 0.9
            })
        );
        cilindro.position.y = 10;
        grupo.add(cilindro);
        
        // ESFERA PULSANTE NO TOPO
        const esfera = new THREE.Mesh(
            new THREE.SphereGeometry(1.5, 8, 8),
            new THREE.MeshBasicMaterial({ color: cor })
        );
        esfera.position.y = 20;
        grupo.add(esfera);
        
        // TEXTO GRANDE (SPRITE)
        const canvas = document.createElement('canvas');
        canvas.width = 256;
        canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = cor === 0xff00ff ? '#ff00ff' : '#00ffff';
        ctx.font = 'bold 30px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(texto, 128, 40);
        
        const texture = new THREE.CanvasTexture(canvas);
        const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
        sprite.scale.set(8, 2, 1);
        sprite.position.y = 25;
        grupo.add(sprite);
        
        grupo.position.copy(pos);
        grupo.position.y += 1;
        
        scene.add(grupo);
        return grupo;
    }
    
    // 8. BOT√ïES
    setTimeout(() => {
        const btnChapa = document.getElementById('btn-chapa');
        const btnBalcao = document.getElementById('btn-balcao');
        
        if(btnChapa) {
            btnChapa.onclick = function() {
                if(!player) return alert("Sem player!");
                
                if(window.chefState.chapaObj) scene.remove(window.chefState.chapaObj);
                
                const pos = player.position.clone();
                window.chefState.chapaObj = criarMarcador(0xff00ff, 'üî• CHAPA', pos);
                window.chefState.chapaPos = pos;
                
                document.getElementById('chef-status').innerHTML = '‚úÖ CHAPA MARCADA!';
                console.log('CHAPA:', pos);
            };
        }
        
        if(btnBalcao) {
            btnBalcao.onclick = function() {
                if(!player) return alert("Sem player!");
                
                if(window.chefState.balcaoObj) scene.remove(window.chefState.balcaoObj);
                
                const pos = player.position.clone();
                window.chefState.balcaoObj = criarMarcador(0x00ffff, 'üí∞ BALC√ÉO', pos);
                window.chefState.balcaoPos = pos;
                
                document.getElementById('chef-status').innerHTML = '‚úÖ BALC√ÉO MARCADO!';
                console.log('BALC√ÉO:', pos);
            };
        }
    }, 100);
    
    // 9. LOOP DE VERIFICA√á√ÉO
    window.chefTimer = setInterval(() => {
        if(!player || !window.chefState.chapaPos || !window.chefState.balcaoPos) return;
        
        // ANIMA MARCADORES
        if(window.chefState.chapaObj) {
            window.chefState.chapaObj.rotation.y += 0.02;
        }
        if(window.chefState.balcaoObj) {
            window.chefState.balcaoObj.rotation.y -= 0.02;
        }
        
        // VERIFICA DIST√ÇNCIA
        const distChapa = player.position.distanceTo(window.chefState.chapaPos);
        const distBalcao = player.position.distanceTo(window.chefState.balcaoPos);
        const statusEl = document.getElementById('chef-status');
        
        // L√ìGICA DE COZINHAMENTO
        if(distChapa < 15 && window.chefState.fase === "AGUARDANDO") {
            window.chefState.fase = "COZINHANDO";
            let progresso = 0;
            
            const cozinhar = setInterval(() => {
                if(!player) return clearInterval(cozinhar);
                const novaDist = player.position.distanceTo(window.chefState.chapaPos);
                
                if(novaDist >= 15) {
                    clearInterval(cozinhar);
                    window.chefState.fase = "AGUARDANDO";
                    statusEl.innerHTML = '‚ùå COZINHA INTERROMPIDA';
                    return;
                }
                
                progresso += 20;
                statusEl.innerHTML = `üî• COZINHANDO: ${progresso}%`;
                
                if(progresso >= 100) {
                    clearInterval(cozinhar);
                    window.chefState.fase = "PRONTO";
                    statusEl.innerHTML = '‚úÖ PRONTO! LEVE AO BALC√ÉO';
                }
            }, 500);
        }
        
        // ENTREGA
        if(distBalcao < 15 && window.chefState.fase === "PRONTO") {
            window.chefState.moedas += 50;
            document.getElementById('chef-money').innerHTML = `$${window.chefState.moedas}`;
            window.chefState.fase = "AGUARDANDO";
            statusEl.innerHTML = 'üí∞ +$50! PRONTO PARA MAIS';
        }
        
    }, 100);
    
    alert("üéÆ MODO COZINHEIRO CARREGADO!\n\nClique nos bot√µes ROSA e AZUL para marcar os locais!");
};

// 10. SE NADA FUNCIONOU, TENTA PEDIR AJUDA
setTimeout(() => {
    if(!window.chefState) {
        alert("‚ùå N√ÉO FOI POSS√çVEL CONECTAR!\n\nDigite no console:\nwindow.iniciarCozinhaFinal(scene, player)");
    }
}, 2000);